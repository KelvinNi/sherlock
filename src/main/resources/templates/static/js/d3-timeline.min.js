// https://github.com/jiahuang/d3-timeline
// MIT license
d3.timeline=function(){function t(t){function n(t,n){return _.left+(t.starting_time-w)*j}function c(t,n){return _.left+(t.starting_time-w)*j+5}function l(n,e){t.append("svg:line").attr("x1",n).attr("y1",e.marginTop).attr("x2",n).attr("y2",g-e.marginBottom).style("stroke",e.color).style("stroke-width",e.width)}var u=t.append("g"),v=t[0][0].getBoundingClientRect(),B=d3.select(t[0][0]),S={},V=1,L=0,R=0;!function(){if(f||v.width){if(!f||!v.width)try{f=B.attr("width")}catch(t){console.log(t)}}else try{if(!(f=B.attr("width")))throw"width of the timeline is not set. As of Firefox 27, timeline().with(x) needs to be explicitly set in order to render"}catch(t){console.log(t)}}(),F&&u.each(function(t,n){t.forEach(function(t,n){t.times.forEach(function(t,e){0===n&&0===e?(originTime=t.starting_time,t.starting_time=0,t.ending_time=t.ending_time-originTime):(t.starting_time=t.starting_time-originTime,t.ending_time=t.ending_time-originTime)})})}),(T||0===y||0===w)&&(u.each(function(t,n){t.forEach(function(t,n){T&&-1==Object.keys(S).indexOf(n)&&(S[n]=V,V++),t.times.forEach(function(t,n){0===w&&(t.starting_time<L||0===L&&!1===F)&&(L=t.starting_time),0===y&&t.ending_time>R&&(R=t.ending_time)})})}),0===y&&(y=R),0===w&&(w=L));var j=1/(y-w)*(f-_.left-_.right),D=d3.time.scale().domain([w,y]).range([_.left,f-_.right]),W=d3.svg.axis().scale(D).orient(s).tickFormat(d.format).tickSize(d.tickSize);null!=d.tickValues?W.tickValues(d.tickValues):W.ticks(d.numTicks||d.tickTime,d.tickInterval),u.each(function(o,l){N=o,o.forEach(function(o,l){function s(t,n){return T?_.top+(A+E)*S[l]:_.top}var g=o.times,d=void 0!==o.label;if(void 0!==o.id&&console.warn("d3Timeline Warning: Ids per dataset is deprecated in favor of a 'class' key. Ids are now per data element."),m&&K(S,l,u,g,o),u.selectAll("svg").data(g).enter().append(function(t,n){return document.createElementNS(d3.ns.prefix.svg,"display"in t?t.display:k)}).attr("x",n).attr("y",s).attr("width",function(t,n){return(t.ending_time-t.starting_time)*j}).attr("cy",function(t,n){return s(t,n)+A/2}).attr("cx",n).attr("r",A/2).attr("height",A).style("fill",function(t,n){var e;return t.color?t.color:x?(e=t[x],p(e||o[x])):p(l)}).on("mousemove",function(t,n){e(t,l,o)}).on("mouseover",function(t,n){r(t,n,o)}).on("mouseout",function(t,n){i(t,n,o)}).on("click",function(t,n){a(t,l,o)}).attr("class",function(t,n){return o.class?"timelineSeries_"+o.class:"timelineSeries_"+l}).attr("id",function(t,n){return o.id&&!t.id?"timelineItem_"+o.id:t.id?t.id:"timelineItem_"+l+"_"+n}),u.selectAll("svg").data(g).enter().append("text").attr("x",c).attr("y",function(t,n){return T?_.top+(A+E)*S[l]+.75*A:_.top+.75*A}).text(function(t){return t.label}),h){var w=A+E/2+_.top+(A+E)*S[l];t.append("svg:line").attr("class","row-separator").attr("x1",0+_.left).attr("x2",f-_.right).attr("y1",w).attr("y2",w).attr("stroke-width",1).attr("stroke",h)}d&&Q(t,S,l,d,o),void 0!==o.icon&&t.append("image").attr("class","timeline-label").attr("transform","translate(0,"+(_.top+(A+E)*S[l])+")").attr("xlink:href",o.icon).attr("width",_.left).attr("height",A)})});var q=_.top+(A+E)*V,G=_.top,U=Y?G:q;if(I&&P(u,W,U),M&&J(u,W,V),f>v.width){var X=d3.behavior.zoom().x(D).on("zoom",function(){var t=Math.min(0,Math.max(v.width-f,d3.event.translate[0]));X.translate([t,0]),u.attr("transform","translate("+t+",0)"),o(t*j,D)});t.attr("class","scrollable").call(X)}b&&u.selectAll(".tick text").attr("transform",function(t){return"rotate("+b+")translate("+(this.getBBox().width/2+10)+","+this.getBBox().height/2+")"});var Z=u[0][0].getBoundingClientRect();!function(){if(g||B.attr("height"))g?B.attr("height",g):g=B.attr("height");else{if(!A)throw"height of the timeline is not set";g=Z.height+Z.top-v.top,d3.select(t[0][0]).attr("height",g)}}(),O&&u.each(function(t,n){t.forEach(function(t){t.times.forEach(function(t){l(D(t.starting_time),H),l(D(t.ending_time),H)})})}),z&&l(D(new Date),C)}var n=["circle","rect"],e=function(){},r=function(){},i=function(){},a=function(){},o=function(){},c=function(t){return t},l=function(){},u=function(){},s="bottom",f=null,g=null,h=null,m=null,d={format:d3.time.format("%I %p"),tickTime:d3.time.hours,tickInterval:1,tickSize:6,tickValues:null},p=d3.scale.category20(),x=null,k="rect",w=0,v=0,y=0,_={left:30,right:30,top:30,bottom:30},T=!1,b=!1,F=!1,B=!1,A=20,E=5,S=60,I=!0,Y=!1,z=!1,M=!1,V={stroke:"stroke-dasharray",spacing:"4 10"},C={marginTop:25,marginBottom:0,width:1,color:p},O=!1,H={marginTop:25,marginBottom:0,width:1,color:p},L=!1,R=!1,j=!1,D="white",N={},P=function(t,n,e){L&&G(t,0,0),R&&q(t),t.append("g").attr("class","axis").attr("transform","translate(0,"+e+")").call(n)},W=function(t){var n=w.getFullYear();w.getFullYear()!=y.getFullYear()&&(n=w.getFullYear()+"-"+y.getFullYear()),t.append("text").attr("transform","translate(20, 0)").attr("x",0).attr("y",14).attr("class","calendarYear").text(n)},q=function(t){var n=_.left-S,e=(f-_.left)/6,r=f-_.right-e+S,i=t.append("g").attr("class","axis").attr("transform","translate(0, 20)");j&&W(i),i.append("text").attr("transform","translate("+n+", 0)").attr("x",0).attr("y",14).attr("class","chevron").text("<").on("click",function(){return l(w,N)}),i.append("text").attr("transform","translate("+r+", 0)").attr("x",0).attr("y",14).attr("class","chevron").text(">").on("click",function(){return u(y,N)})},G=function(t,n,e){t.insert("rect").attr("class","row-green-bar").attr("x",n).attr("width",f).attr("y",e).attr("height",A).attr("fill",D)},J=function(t,n,e){t.append("g").attr("class","axis").attr("transform","translate(0,"+(_.top+(A+E)*e)+")").attr(V.stroke,V.spacing).call(n.tickFormat("").tickSize(-(_.top+(A+E)*(e-1)+3),0,0))},K=function(t,n,e,r,i){var a=(A+E)*t[n]+_.top;e.selectAll("svg").data(r).enter().insert("rect").attr("class","row-green-bar").attr("x",B?0:_.left).attr("width",B?f:f-_.right-_.left).attr("y",a).attr("height",A).attr("fill",m instanceof Function?m(i,n):m)},Q=function(t,n,e,r,i){var o=A+E,l=_.top+o/2+o*(n[e]||1);t.append("text").attr("class","timeline-label").attr("transform","translate("+v+","+l+")").text(r?c(i.label):i.id).on("click",function(t,n){a(t,e,i)})};return t.margin=function(n){return arguments.length?(_=n,t):_},t.orient=function(n){return arguments.length?(s=n,t):s},t.itemHeight=function(n){return arguments.length?(A=n,t):A},t.itemMargin=function(n){return arguments.length?(E=n,t):E},t.navMargin=function(n){return arguments.length?(S=n,t):S},t.height=function(n){return arguments.length?(g=n,t):g},t.width=function(n){return arguments.length?(f=n,t):f},t.display=function(e){return arguments.length&&-1!=n.indexOf(e)?(k=e,t):k},t.labelFormat=function(n){return arguments.length?(c=n,t):c},t.tickFormat=function(n){return arguments.length?(d=n,t):d},t.hover=function(n){return arguments.length?(e=n,t):e},t.mouseover=function(n){return arguments.length?(r=n,t):r},t.mouseout=function(n){return arguments.length?(i=n,t):i},t.click=function(n){return arguments.length?(a=n,t):a},t.scroll=function(n){return arguments.length?(o=n,t):o},t.colors=function(n){return arguments.length?(p=n,t):p},t.beginning=function(n){return arguments.length?(w=n,t):w},t.ending=function(n){return arguments.length?(y=n,t):y},t.labelMargin=function(n){return arguments.length?(v=n,t):v},t.rotateTicks=function(n){return arguments.length?(b=n,t):b},t.stack=function(){return T=!T,t},t.relativeTime=function(){return F=!F,t},t.showBorderLine=function(){return O=!O,t},t.showBorderFormat=function(n){return arguments.length?(H=n,t):H},t.showToday=function(){return z=!z,t},t.showTodayFormat=function(n){return arguments.length?(C=n,t):C},t.colorProperty=function(n){return arguments.length?(x=n,t):x},t.rowSeparators=function(n){return arguments.length?(h=n,t):h},t.background=function(n){return arguments.length?(m=n,t):m},t.showTimeAxis=function(){return I=!I,t},t.showAxisTop=function(){return Y=!Y,t},t.showAxisCalendarYear=function(){return j=!j,t},t.showTimeAxisTick=function(){return M=!M,t},t.fullLengthBackgrounds=function(){return B=!B,t},t.showTimeAxisTickFormat=function(n){return arguments.length?(V=n,t):V},t.showAxisHeaderBackground=function(n){return L=!L,n&&(D=n),t},t.navigate=function(n,e){return arguments.length?(l=n,u=e,R=!R,t):[l,u]},t};